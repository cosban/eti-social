<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ETI Social test page</title>
</head>
<body>
</body>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>
    var socket = io();
    var users = [];

    var ul = document.createElement('ul');
    document.body.appendChild(ul);

    function getUsername() {
        var username = localStorage.getItem('eti-username') || prompt('Enter your nickname!');
        localStorage.setItem('eti-username', username);
        return username;
    }

    function drawUsers() {
        console.log('drawing users:', users);
        ul.innerHTML = '';
        users.forEach(function (user) {
            ul.innerHTML += '<li>' + user.name + '</li>';
        });
    }

    socket.on('activeUsers', function (activeUsers) {
        users = activeUsers;
        drawUsers();
    });
    socket.on('joined', function (joining) {
        console.log(joining.name, 'joined the room');
        users.push(joining);
        drawUsers();
    });
    socket.on('left', function (leaving) {
        console.log(leaving.name, 'left the room');
        users.splice(users.indexOf(users.filter(function (user) {
            return user.name === leaving.name;
        })[0]), 1);
        drawUsers();
    });


    var topicId = parseInt(location.href.match(/topic=(\d+)/)[1]);

    socket.emit('topic', {
        user: {
            name: getUsername()
        },
        id: topicId
    });
</script>
</html>